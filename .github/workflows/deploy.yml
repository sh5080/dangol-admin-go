name: Build and Deploy Lambda

on:
  push:
    branches: [main] # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Set up AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Set up SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Start Deployment Notification
        run: |
          curl -X POST -H "Content-type: application/json" \
          --data "{\"text\":\"ğŸ”„ Lambda ë°°í¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.\n- ë¦¬í¬ì§€í† ë¦¬: ${{ github.repository }}\n- ë¸Œëœì¹˜: ${{ github.ref_name }}\n- ì»¤ë°‹: ${{ github.sha }}\"}" \
          "${{ secrets.SWIT_WEBHOOK_URL }}"

      - name: Build
        run: |
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -o main main.go
          chmod +x main
          echo '#!/bin/sh
          ./main' > bootstrap
          chmod +x bootstrap

      - name: Package
        id: package
        run: |
          sam package \
            --template-file template.yaml \
            --output-template-file packaged.yaml \
            --s3-bucket ${{ secrets.S3_BUCKET }}

      - name: Deploy
        id: deploy
        run: |
          sam deploy \
            --template-file packaged.yaml \
            --stack-name admin-lambda \
            --capabilities CAPABILITY_IAM \
            --parameter-overrides \
              DBHost=${{ secrets.DB_HOST }} \
              DBUser=${{ secrets.DB_USER }} \
              DBPassword=${{ secrets.DB_PASSWORD }} \
              DBName=${{ secrets.DB_NAME }} \
              DBSSLMode=require
          echo "STACK_ID=$(aws cloudformation describe-stacks --stack-name admin-lambda --query 'Stacks[0].StackId' --output text)" >> $GITHUB_ENV

      - name: Check Stack Status
        id: check_stack
        run: |
          MAX_ATTEMPTS=20
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Checking stack status (attempt $ATTEMPT/$MAX_ATTEMPTS)..."
            
            STACK_STATUS=$(aws cloudformation describe-stacks --stack-name admin-lambda --query 'Stacks[0].StackStatus' --output text)
            
            if [[ "$STACK_STATUS" == *"COMPLETE"* && "$STACK_STATUS" != *"ROLLBACK"* ]]; then
              # ë°°í¬ ì„±ê³µ
              API_URL=$(aws cloudformation describe-stacks --stack-name admin-lambda --query 'Stacks[0].Outputs[?OutputKey==`PresignedURLEndpoint`].OutputValue' --output text)
              
              curl -X POST -H "Content-type: application/json" \
              --data "{\"text\":\"âœ… Lambda ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n- ìŠ¤íƒ ID: ${{ env.STACK_ID }}\n- API ì—”ë“œí¬ì¸íŠ¸: ${API_URL}\"}" \
              "${{ secrets.SWIT_WEBHOOK_URL }}"
              exit 0
              
            elif [[ "$STACK_STATUS" == *"FAILED"* || "$STACK_STATUS" == *"ROLLBACK"* ]]; then
              # ë°°í¬ ì‹¤íŒ¨
              ERROR=$(aws cloudformation describe-stack-events --stack-name admin-lambda --query 'StackEvents[?ResourceStatus==`CREATE_FAILED` || ResourceStatus==`UPDATE_FAILED`].ResourceStatusReason' --output text | head -n 1)
              
              curl -X POST -H "Content-type: application/json" \
              --data "{\"text\":\"âŒ Lambda ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n- ìƒíƒœ: ${STACK_STATUS}\n- ì˜¤ë¥˜: ${ERROR}\n- ìŠ¤íƒ ID: ${{ env.STACK_ID }}\"}" \
              "${{ secrets.SWIT_WEBHOOK_URL }}"
              exit 1
              
            else
              # ì•„ì§ ì§„í–‰ ì¤‘ì¸ ìƒíƒœ
              echo "Deployment still in progress. Status: ${STACK_STATUS}"
              sleep 15
              ATTEMPT=$((ATTEMPT + 1))
            fi
          done

          # ì‹œê°„ ì´ˆê³¼
          curl -X POST -H "Content-type: application/json" \
          --data "{\"text\":\"âš ï¸ Lambda ë°°í¬ ìƒíƒœ í™•ì¸ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. AWS ì½˜ì†”ì—ì„œ í™•ì¸í•˜ì„¸ìš”.\n- ìŠ¤íƒ ID: ${{ env.STACK_ID }}\"}" \
          "${{ secrets.SWIT_WEBHOOK_URL }}"
          exit 1

      - name: Notify Failure
        if: failure()
        run: |
          curl -X POST -H "Content-type: application/json" \
          --data "{\"text\":\"âŒ Lambda ë°°í¬ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n- ë¦¬í¬ì§€í† ë¦¬: ${{ github.repository }}\n- ë¸Œëœì¹˜: ${{ github.ref_name }}\n- ì»¤ë°‹: ${{ github.sha }}\"}" \
          "${{ secrets.SWIT_WEBHOOK_URL }}"
